# render.yaml (Final Version with all Corrections)

services:
  # -----------------
  #  1. Redis Service
  # -----------------
  - type: redis
    name: redis-broker
    plan: free
    ipAllowList:
      - source: 0.0.0.0/0
        description: "Allow all connections"

  # -----------------
  #  2. FastAPI Web Service (the API)
  # -----------------
  - type: web
    name: contract-api
    plan: free
    runtime: docker # 'runtime: docker' is correct for 'type: web'
    dockerfilePath: ./Dockerfile
    dockerContext: .
    envVars:
      - fromGroup: contract-app-env
    # Free tier does not support persistent disks.
    # Health check path is correct.
    healthCheckPath: /

  # -----------------
  #  3. Celery Background Worker
  # -----------------
  - type: worker
    name: contract-worker
    plan: free
    # --- CRITICAL FIX ---
    # A Docker-based worker REQUIRES 'runtime: docker' to be specified.
    # This was the cause of the previous errors.
    runtime: docker
    # ---
    dockerfilePath: ./Dockerfile
    dockerContext: .
    startCommand: celery -A tasks.celery_worker worker --loglevel=info --pool=solo
    envVars:
      - fromGroup: contract-app-env
    # Free tier does not support persistent disks.

# --- Environment Group Declaration ---
# This section declares that the services above will use a group managed in the UI.
envVarGroups:
  - name: contract-app-env